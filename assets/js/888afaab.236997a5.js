(self.webpackChunkfossology_blogs=self.webpackChunkfossology_blogs||[]).push([[3869],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return c},kt:function(){return h}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},s=Object.keys(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),u=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=u(e.components);return o.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(n),h=a,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||s;return n?o.createElement(m,r(r({ref:t},c),{},{components:n})):o.createElement(m,r({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,r=new Array(s);r[0]=p;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,r[1]=i;for(var u=2;u<s;u++)r[u]=n[u];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},908:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return r},metadata:function(){return i},toc:function(){return l},default:function(){return c}});var o=n(2122),a=n(9756),s=(n(7294),n(3905)),r={},i={unversionedId:"docs/Nomos",id:"docs/Nomos",isDocsHomePage:!1,title:"Nomos",description:"Thanks go to Raino for starting this page.",source:"@site/docs/docs/Nomos.md",sourceDirName:"docs",slug:"/docs/Nomos",permalink:"/fossology-blogs/docs/docs/Nomos",editUrl:"https://github.com/Aman-Codes/fossology-blogs/edit/master/docs/docs/Nomos.md",version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"New-at-FOSSology,-You-Could-...",permalink:"/fossology-blogs/docs/docs/New-at-FOSSology,-You-Could-..."},next:{title:"Notepad-Building-Packages",permalink:"/fossology-blogs/docs/docs/Notepad-Building-Packages"}},l=[{value:"Command Line",id:"command-line",children:[]},{value:"Licenses",id:"licenses",children:[]},{value:"How to Add a New License Signature",id:"how-to-add-a-new-license-signature",children:[{value:"Step 1: Add the new signature - STRINGS.in",id:"step-1-add-the-new-signature---stringsin",children:[]},{value:"Step 2: Change the scanner - parse.c",id:"step-2-change-the-scanner---parsec",children:[]},{value:"Install",id:"install",children:[]},{value:"Contribute or Fork?",id:"contribute-or-fork",children:[]}]},{value:"Debugging",id:"debugging",children:[{value:"Activating traces",id:"activating-traces",children:[]}]},{value:"Rescanning",id:"rescanning",children:[{value:"New scan Option 1 - saving old and new results",id:"new-scan-option-1---saving-old-and-new-results",children:[]},{value:"Rescan Option 2 - destroy old results, then rescan",id:"rescan-option-2---destroy-old-results-then-rescan",children:[]},{value:"Remove Results for a single upload",id:"remove-results-for-a-single-upload",children:[]},{value:"Removing all license results",id:"removing-all-license-results",children:[]}]},{value:"Start the rescan",id:"start-the-rescan",children:[]}],u={toc:l};function c(e){var t=e.components,n=(0,a.Z)(e,["components"]);return(0,s.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"Thanks go to Raino for starting this page."),(0,s.kt)("p",null,"The following modifications to the license scanner require you to use development tools as well as using psql, phppgadmin, pgadmin3, or some other client to send sql commands directly to the postgres database engine. You might consider backing up your database (pg_dump) before doing direct sql database updates."),(0,s.kt)("h2",{id:"command-line"},"Command Line"),(0,s.kt)("p",null,"Nomos can be run from the command line:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"./nomos myfile.c\n")),(0,s.kt)("p",null,"The output is in this format:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"File myfile.c contains license(s) AFL_v3.0, GPL_v2.1+\n")),(0,s.kt)("p",null,"The option ",(0,s.kt)("inlineCode",{parentName:"p"},"-S")," is a mode where Nomos prints the highlighting information as a result of the call. In Fossology, it is used to make the color highlighting in the Nomos OneShot GUI. You could use it to write your own highlighting.\nThe index is used to determine which license the finding corresponds to."),(0,s.kt)("p",null,"It returns keyword position, length and index. The index is used to determine which license the finding corresponds to."),(0,s.kt)("h2",{id:"licenses"},"Licenses"),(0,s.kt)("p",null,"The licenses that Nomos scans for are ",(0,s.kt)("a",{parentName:"p",href:"http://www.fossology.org/projects/fossology/wiki/Nomos_liclist_"},"here.")),(0,s.kt)("h2",{id:"how-to-add-a-new-license-signature"},"How to Add a New License Signature"),(0,s.kt)("p",null,"Adding a new license has three steps. In the first step you create a new license signature. In the second step you have to add the signature check to the scanner source code. The third step is to install the updated agent. The files are in the src/nomos/agent/."),(0,s.kt)("h3",{id:"step-1-add-the-new-signature---stringsin"},"Step 1: Add the new signature - STRINGS.in"),(0,s.kt)("p",null,"Nomos does license identification using short phrases (regular expressions) and heuristics (e.g. phrase must be found in (or out of) proximity to another phrase or phrases."),(0,s.kt)("p",null,'Nomos may also identify a "style" type of license if it has similarities with a known license type.'),(0,s.kt)("p",null,"The file STRINGS.IN define the text portion of a license signature."),(0,s.kt)("p",null,"For example:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},' %ENTRY% _TITLE_XYZ-LICENSE1\n  %KEY%      "licen[cs]" \n  %STR%      "XYZ-licen[cs]e (v|version ) 1\\.?0" \n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"Note syntax. These are regular expressions.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"The ENTRY is a constant used in the code (step 2).")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"KEY is a simple regular expression. This is used to quickly scan the code to see if we should look further for the XYZ license. KEY's are not unique between all the key signatures.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"STR is regular expression signature of something unique about the license. It depends on KEY being found first.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"In the top of STRINGS.IN you will find notes about how to update the file."))),(0,s.kt)("h3",{id:"step-2-change-the-scanner---parsec"},"Step 2: Change the scanner - parse.c"),(0,s.kt)("p",null,"The second part of the license signature are the heuristics. These interpret when and how your entry in STRINGS.IN should be interpreted. This happens in parse.c. If the new license was identified a style type license then add to right place a new else if block like:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},' else if (INFILE(_TITLE_XYZ-LICENSE1)) {\n    INTERESTING("XYZ_v1.0");\n  }\n')),(0,s.kt)("p",null,"Nomos agent has to be now recompiled (make). Before you install the new agent you should test it on the command line. "),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"}," ./nomos myfile.c\n")),(0,s.kt)("p",null,"Sample output:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"  File myfile.c contains license(s) XYZ_v1.0, LGPL_v2.1\n")),(0,s.kt)("h3",{id:"install"},"Install"),(0,s.kt)("p",null,"The updated agent can be installed from the nomos directory:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-Bash"},"/etc/init.d/fossology stop\nsudo make install\n/etc/init.d/fossology start\n")),(0,s.kt)("h3",{id:"contribute-or-fork"},"Contribute or Fork?"),(0,s.kt)("p",null,"After you've gone though the effort of creating license signatures, recompiling, and installing your updated scanner, guess what happens the next time you upgrade your fossology package? Yep, we will replace your custom scanner with our new one and all your changes will be lost. That would probably irritate you as much as it would me. You should probably consider one of two approaches:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Contribute your new license signatures back to the project.")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Maintain your own diffs."))),(0,s.kt)("h2",{id:"debugging"},"Debugging"),(0,s.kt)("h3",{id:"activating-traces"},"Activating traces"),(0,s.kt)("p",null,"Activating the defines of PROC_TRACE and/or DOCTOR_DEBUG (see ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/fossology/fossology/blob/master/src/nomos/agent/parse.c#L31"},"line 31 of file parse.c"),") Nomos generates lot of tracing information that is really helpful to debug it."),(0,s.kt)("p",null,'PROC_TRACE will show you, for example, which regex\'s were tried and which are successful. To see the successful matches, grep the output file for "addRef".'),(0,s.kt)("p",null,'DOCTOR_DEBUG will show you the before and after versions of the buffer to be processed. Look in the output file or "----- ',"[Dr-BEFORE:]",' -----" and "+++++ ',"[Dr-AFTER]",' +++:"'),(0,s.kt)("h2",{id:"rescanning"},"Rescanning"),(0,s.kt)("p",null,"Changes to the license phrase file STRINGS.in and/or the code in parse.c are not automatically applied to previous license results. To reiterate, files that are already processed will not be reprocessed with the updated license phrases/code unless you force them to. This bears repeating: ",(0,s.kt)("strong",{parentName:"p"},"EVEN IF YOU RE-UPLOAD FILES AS A NEW UPLOAD")," your scanner will not run on any which have been scanned before, and you will get old results. This can make it seem like your Nomos is not working, and lead to the tearing-out of hair. Files will be rescanned if you install a newer version of nomos or follow the options below."),(0,s.kt)("h3",{id:"new-scan-option-1---saving-old-and-new-results"},"New scan Option 1 - saving old and new results"),(0,s.kt)("p",null,"If you want to keep all your old scan data available, but have your new scans use your custom nomos program, you need to create a new version record for the agent:"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"SELECT * FROM agent WHERE agent_name='nomos' ORDER BY agent_rev ASC LIMIT 1;")),(0,s.kt)("p",null,'Duplicate this record and increment the agent_ref. If your agent record has a NULL or "default" in the agent_rev, just make up your own revision, like "1" or "2".'),(0,s.kt)("p",null,"Once you have created a new agent record with an incremented revision, any new scan you request will use your custom nomos scanner."),(0,s.kt)("p",null,"If you want to rescan an upload:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},'Click on the main "Browse" tab.')),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Navigate using the left navigation bar till you see your upload in the right hand window.")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},'Click on the "jobs" link to see the history of jobs run on your upload.')),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},'On the right side of the window, locate the "Reset | Delete" actions for the agent you wish to rerun.')),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},'Click on "Delete". The window will refresh and the job will be gone.')),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},'Select "Jobs" \u2192 \u201cAgents\u201d from the top menu bar.')),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Select the folder containing the upload you wish to analyze.")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Select the upload to analyze.")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"A list of analyses available for the upload are listed in step 3.")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},'Select the nomos and Click on the "Analyze" button.')),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"The job is automatically queued up & run."))),(0,s.kt)("p",null,"Notice that this method didn't delete any of your own data. That data will still be in the database and you can see it by selecting the nomos version in the nomos license browser. Since you didn't delete any previous data, you also won't break bucket results that depended on it."),(0,s.kt)("p",null,"I know we should make this easier for fossology system admins. If you feel the same, let us know in our public mailing list ",(0,s.kt)("a",{parentName:"p",href:"mailto:fossology@fossology.org"},"fossology@fossology.org"),"."),(0,s.kt)("h3",{id:"rescan-option-2---destroy-old-results-then-rescan"},"Rescan Option 2 - destroy old results, then rescan"),(0,s.kt)("p",null,"If you would like to remove your old nomos license results, and then rescan, this section is for you. You can either remove results for individual uploads, or remove all the nomos results for everything in the repository."),(0,s.kt)("h3",{id:"remove-results-for-a-single-upload"},"Remove Results for a single upload"),(0,s.kt)("p",null,'First you need to identify the upload whose results you want to remove. This means finding the numeric key that fossology uses to identify uploads. You could do this by browsing the database table "upload". The information you need is the primary key "upload_pk". Another way to do it is to use the fossology file browser. In the url you will see an "upload" parameter. For example, if the url is:'),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"#"},"http://myfossology.com/?mod=browse&folder=1&show=detail&upload=16&item=3178627")),(0,s.kt)("p",null,"The upload_pk is 16."),(0,s.kt)("p",null,"Now that you know the upload key, you can erase all the license results for that upload with:"),(0,s.kt)("p",null,"DELETE FROM license_file WHERE pfile_fk IN (SELECT pfile_fk FROM uploadtree WHERE upload_fk=16);"),(0,s.kt)("p",null,"Next you need to remove the audit trail records for the previous license scan:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"DELETE FROM nomos_ars WHERE upload_fk=16;\n")),(0,s.kt)("h3",{id:"removing-all-license-results"},"Removing all license results"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"DELETE FROM license_file;\n")),(0,s.kt)("p",null,"Next you need to remove the audit trail records for all the previous license scans:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"DELETE FROM nomos_ars;\n")),(0,s.kt)("h2",{id:"start-the-rescan"},"Start the rescan"),(0,s.kt)("p",null,"To rescan you need to reset the previous scan jobs in the jobqueue table by setting jq_endtime, jq_endtext to null where jq_type='nomos'. If you really want to be complete you can zero out jq_end_bits, jq_elapsedtime, jq_processedtime, jq_itemsprocessed in the same records. Finally, you need to queue something. When you do that the scheduler will notice all the changes you made, see all the incomplete jobs (started but no jq_endtime), queue them up, and run them. This is NOT recommended. Maybe I should have said that first. Well, it's not recommended if you have bucket scan data. This is because the bucket results are dependent on the previous license scan. The above instructions would be fine if you also remove ALL your bucket results (empty bucket_ars, bucket_file, bucket_container tables). You can requeue all the bucket scans just like the nomos scans for jq_type='buckets'."))}c.isMDXComponent=!0}}]);