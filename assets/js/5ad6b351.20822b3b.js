(self.webpackChunkfossology_blogs=self.webpackChunkfossology_blogs||[]).push([[6893],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return c},kt:function(){return p}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),u=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return o.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},f=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),f=u(n),p=r,k=f["".concat(s,".").concat(p)]||f[p]||d[p]||a;return n?o.createElement(k,l(l({ref:t},c),{},{components:n})):o.createElement(k,l({ref:t},c))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=f;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var u=2;u<a;u++)l[u]=n[u];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}f.displayName="MDXCreateElement"},3920:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return l},metadata:function(){return i},toc:function(){return s},default:function(){return c}});var o=n(2122),r=n(9756),a=(n(7294),n(3905)),l={},i={unversionedId:"docs/Notes-on-SQL-Database-Operations",id:"docs/Notes-on-SQL-Database-Operations",isDocsHomePage:!1,title:"Notes-on-SQL-Database-Operations",description:"Notes on Query Optimization",source:"@site/docs/docs/Notes-on-SQL-Database-Operations.md",sourceDirName:"docs",slug:"/docs/Notes-on-SQL-Database-Operations",permalink:"/fossology-blogs/docs/docs/Notes-on-SQL-Database-Operations",editUrl:"https://github.com/Aman-Codes/fossology-blogs/edit/master/docs/docs/Notes-on-SQL-Database-Operations.md",version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Notepad-Building-Packages",permalink:"/fossology-blogs/docs/docs/Notepad-Building-Packages"},next:{title:"Obligations-management",permalink:"/fossology-blogs/docs/docs/Obligations-management"}},s=[{value:"Notes on Query Optimization",id:"notes-on-query-optimization",children:[]},{value:"Useful SQL Commands",id:"useful-sql-commands",children:[{value:"Delete copyright records for an upload",id:"delete-copyright-records-for-an-upload",children:[]},{value:"Delete nomos license records for an upload",id:"delete-nomos-license-records-for-an-upload",children:[]}]},{value:"Bucket SQL Commands",id:"bucket-sql-commands",children:[{value:"Selecting bucket_file records",id:"selecting-bucket_file-records",children:[]},{value:"Selecting bucket_container records",id:"selecting-bucket_container-records",children:[]}]}],u={toc:s};function c(e){var t=e.components,n=(0,r.Z)(e,["components"]);return(0,a.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"notes-on-query-optimization"},"Notes on Query Optimization"),(0,a.kt)("p",null,"When experiencing performance problems:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"extract the query"),(0,a.kt)("li",{parentName:"ul"},"try to run every element of the query alone and see which is taking most time"),(0,a.kt)("li",{parentName:"ul"},"try to run the query with individual constraints deactivated and try to see which of the constraints is taking much time")),(0,a.kt)("p",null,"If the element that takes out time is identified:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"check the indices"),(0,a.kt)("li",{parentName:"ul"},"check if columns a,b can be made an index"),(0,a.kt)("li",{parentName:"ul"},"check if columns a,b,c can be made an index")),(0,a.kt)("h2",{id:"useful-sql-commands"},"Useful SQL Commands"),(0,a.kt)("p",null,'These are examples of SQL statements you might find handy. Don\'t forget to substitute real values for the example values given. For example, if the query says "upload_fk=456", you need to replace 456 with your upload value.'),(0,a.kt)("h3",{id:"delete-copyright-records-for-an-upload"},"Delete copyright records for an upload"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"delete from copyright where pfile_fk in \n    (select distinct(pfile_fk) as pf from uploadtree where upload_fk=454);\n")),(0,a.kt)("p",null,"Warning copyright results are on pfiles (the physical file reference in the database). So if you delete a copyright result for pfile 123 in upload 456, AND another upload (789) refers to pfile 123, then if you delete the results for 456, and do a copyright report on upload 789 you will see all the 789 copyrights with the results for pfile 123 omitted. This is a known problem that is solved in newer agents (nomos, buckets at this v 1.2 time)."),(0,a.kt)("h3",{id:"delete-nomos-license-records-for-an-upload"},"Delete nomos license records for an upload"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"delete from license_file where pfile_fk in \n    (select distinct(pfile_fk) as pf from uploadtree where upload_fk=454);\n")),(0,a.kt)("p",null,"The same warning above for copyrights also apply to nomos results. However, this is still a useful thing to know how to do if you understand the above warning on how pfiles are reused."),(0,a.kt)("p",null,"Sometimes you don't actually want to delete the records, you just want to rescan without breaking any previous reports. To do this, you need to add a new nomos record in the agent table, remember to update the version. Then reschedule the nomos agent. In v 1.2 the user interface to reschedule an agent was not updated to account for agents like nomos that can keep multiple revisions of results. So you can't simply hit the reset link in Show Job Queue. You have to delete the job, then use Jobs > Agents to schedule a new job."),(0,a.kt)("p",null,"Delete bucket records for an upload "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"delete from bucket_ars where upload_fk=97; \n\ndelete from bucket_file where pfile_fk in (select distinct(pfile_fk) as pf from uploadtree where upload_fk=97); \n\ndelete from bucket_container where uploadtree_fk in (select uploadtree_pk from uploadtree where upload_fk=97);\n")),(0,a.kt)("h2",{id:"bucket-sql-commands"},"Bucket SQL Commands"),(0,a.kt)("p",null,"Bucket results are stored in two tables, bucket_file and bucket_container."),(0,a.kt)("p",null,"Table bucket_file is used to relate pfile_pk's to a bucket."),(0,a.kt)("p",null,"Table bucket_container is used to relate uploadtree_pk's to a bucket. This table"),(0,a.kt)("p",null,"is used when the uploadtree_pk has no pfile. For example, directories."),(0,a.kt)("h3",{id:"selecting-bucket_file-records"},"Selecting bucket_file records"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"select distinct bucket_file.pfile_fk, ufile_name, bucket_fk\n\n   from bucket_file,\n\n   (select pfile_fk as PF, ufile_name from uploadtree where upload_fk=444) as SS\n\n where PF=bucket_file.pfile_fk;\n")),(0,a.kt)("p",null,"The above will return the bucket_file recs for upload_pk=444 regardless of the file "),(0,a.kt)("p",null,"being an artifact or which version of the nomos and bucket agents were used to do the scan."),(0,a.kt)("p",null,"The condition to remove artifacts looks like"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"((ufile_mode & (1<&lt;28))=0)\n")),(0,a.kt)("p",null,"So here is the new query to select the non-artifact pfile buckets for a specific scan of an upload, that is, for specific nomos and bucket agent pk's (nomos agent_pk 134 and the bucket agent_pk 151 are used in this example):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"select distinct bucket_file.pfile_fk, ufile_name, bucket_fk,\n\n        nomosagent_fk, agent_fk\n\n from bucket_file,\n\n      (select pfile_fk as PF, ufile_name, ufile_mode from uploadtree\n\n         where upload_fk=444) as SS\n\n where PF=bucket_file.pfile_fk\n\n   and ((ufile_mode & (1<&lt;28))=0)\n\n   and nomosagent_fk=134\n\n   and agent_fk=151;\n")),(0,a.kt)("p",null,"Or if you want the bucket name resolved, add another join:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"select distinct bucket_file.pfile_fk, ufile_name, bucket_fk, bucket_name,\n\n        nomosagent_fk, agent_fk\n\n from bucket_def,\n\n      bucket_file,\n\n      (select pfile_fk as PF, ufile_name, ufile_mode from uploadtree\n\n         where upload_fk=444) as SS\n\n where PF=bucket_file.pfile_fk\n\n   and ((ufile_mode & (1<&lt;28))=0)\n\n   and nomosagent_fk=134\n\n   and agent_fk=151\n\n   and bucket_fk=bucket_pk;\n")),(0,a.kt)("h3",{id:"selecting-bucket_container-records"},"Selecting bucket_container records"),(0,a.kt)("p",null,"The same query for bucket_container is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-SQL"},"select distinct UPK, ufile_name, bucket_fk, bucket_name, \n\nnomosagent_fk, agent_fk \n\nfrom bucket_def, bucket_container, \n\n(select uploadtree_pk as UPK, ufile_name, ufile_mode from uploadtree \n\nwhere upload_fk=444) as SS \n\nwhere UPK=uploadtree_fk \n\nand ((ufile_mode & (1<<28))=0) \n\nand nomosagent_fk=134 \n\nand agent_fk=151 \n\nand bucket_fk=bucket_pk;\n")))}c.isMDXComponent=!0}}]);